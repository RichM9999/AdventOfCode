//https://adventofcode.com/2023/day/11
using System.Collections.Concurrent;

namespace AdventOfCode.Year2023
{
    using Coordinate = (int x, int y);

    class Day11
    {
        int mapSizeY = 140;
        int mapSizeX = 140;

        Dictionary<Coordinate, char> map;
        List<int> emptyRows;
        List<int> emptyColumns;
        ConcurrentDictionary<Coordinate, ConcurrentBag<Coordinate>> galaxyPairs;

        public Day11()
        {
            map = [];
            emptyRows = [];
            emptyColumns = [];
            galaxyPairs = [];
        }

        public void Run()
        {
            var start = DateTime.Now;

            GetData();

            List<Coordinate> galaxies = [];

            foreach (var location in map)
            {
                if (location.Value == '#')
                {
                    galaxies.Add(location.Key);
                }
            }

            for (var i = 0;  i < galaxies.Count - 1; i++)
            {
                var galaxy = galaxies[i];

                for (var j = i + 1; j < galaxies.Count; j++)
                {
                    var pair = galaxies[j];
                    
                    if (!galaxyPairs.ContainsKey(galaxy))
                    {
                        galaxyPairs.TryAdd(galaxy, new());
                    }

                    galaxyPairs[galaxy].Add(pair);
                }
            }

            Console.WriteLine($"Sum of distances with empty rows/columns doubled: {SumDistances(2)}");
            // 9693756
            Console.WriteLine($"{(DateTime.Now - start).TotalMilliseconds}ms");

            Console.WriteLine($"Sum of distances with empty rows/columns duplicated 1,000,000x: {SumDistances(1000000)}");
            // 717878258016
            Console.WriteLine($"{(DateTime.Now - start).TotalMilliseconds}ms");
        }

        long SumDistances(int expansionFactor)
        {
            long sum = 0;
            Parallel.ForEach(galaxyPairs, (galaxy =>
            {
                foreach (var pair in galaxy.Value)
                {
                    var from = (galaxy.Key);
                    var to = (pair);

                    from.x += emptyColumns.Count(c => c < from.x) * (expansionFactor - 1);
                    from.y += emptyRows.Count(c => c < from.y) * (expansionFactor - 1);

                    to.x += emptyColumns.Count(c => c < to.x) * (expansionFactor - 1);
                    to.y += emptyRows.Count(c => c < to.y) * (expansionFactor - 1);
                    Interlocked.Add(ref sum, Math.Abs(from.x - to.x) + Math.Abs(from.y - to.y));
                }
            }));

            return sum;
        }

        void AddMapRow(int row, string data)
        {
            for (var x = 0; x < data.Length; x++)
            {
                var space = data[x];
                map.Add((x, row), space);

            }

            if (!data.Contains('#'))
            {
                emptyRows.Add(row);
            }
        }

        void FindEmptyColumns()
        {
            for (var x = 0; x < mapSizeX - 1; x++)
            {
                var emptyColumn = true;

                for (var y = 0; y < mapSizeY - 1; y++)
                {
                    if (map[(x, y)] == '#')
                    {
                        emptyColumn = false;
                        break;
                    }
                }

                if (emptyColumn)
                {
                    emptyColumns.Add(x);
                }
            }
        }

        void GetData()
        {
            var row = 0;

            AddMapRow(row++, ".................................#.....................................................#..............................................#.....");
            AddMapRow(row++, "..........#.........#..........................................#............................................................................");
            AddMapRow(row++, "..........................................................#.......................................................#............#............");
            AddMapRow(row++, "..#.................................#........................................#.............#.........#...................#..................");
            AddMapRow(row++, "..............#............................#..........#.........................................#..........#................................");
            AddMapRow(row++, ".........................#......................#........................#..................................................................");
            AddMapRow(row++, ".......................................#....................#...............................................................................");
            AddMapRow(row++, "..............................#.................................................................................................#...........");
            AddMapRow(row++, "...................#..............................................#...............#.....................#.........#........................#");
            AddMapRow(row++, "..#......................................................#..................................................................................");
            AddMapRow(row++, ".....................................#...................................................#.........#......................#.................");
            AddMapRow(row++, ".......#...................................#.......#...................#......#.............................................................");
            AddMapRow(row++, ".....................#.....................................................................................#..................#.......#.....");
            AddMapRow(row++, "............................................................................................#...............................................");
            AddMapRow(row++, "..........................#............#....................................................................................................");
            AddMapRow(row++, "...................................................................................#..................#..........#...............#..........");
            AddMapRow(row++, "#........................................................................................#............................#.....................");
            AddMapRow(row++, "........#...........#...............#.............................#...........#.................#....................................#......");
            AddMapRow(row++, "..............................#.............................#...............................................................................");
            AddMapRow(row++, ".................................................#..........................................................................................");
            AddMapRow(row++, ".....#............................................................................#......................#......................#..........#");
            AddMapRow(row++, "................#..................................................................................#........................................");
            AddMapRow(row++, ".........................................................................#..................#..............................#................");
            AddMapRow(row++, "..#..............................................................#..........................................................................");
            AddMapRow(row++, ".........................#...................................................................................#..........................#...");
            AddMapRow(row++, "................................#......................................................................................#....................");
            AddMapRow(row++, ".........#................................................#............#....................................................................");
            AddMapRow(row++, "................#............................................................................#..........#...................................");
            AddMapRow(row++, ".......................................#...........#...........................................................#...........................#");
            AddMapRow(row++, "....................................................................................................................................#.......");
            AddMapRow(row++, "...............................................................................#.............................................#..............");
            AddMapRow(row++, ".....................#............................................................................................#.........................");
            AddMapRow(row++, ".............................#.......................................................#........#..........#.............#....................");
            AddMapRow(row++, "....................................#.......................................................................................................");
            AddMapRow(row++, ".........................................#........#............#........#.................#.................................................");
            AddMapRow(row++, "#.....................................................................................................................................#.....");
            AddMapRow(row++, ".......................#.......#............................................................................................................");
            AddMapRow(row++, "........................................................#.......................#...........................#...............................");
            AddMapRow(row++, "...............#.....................................................................................#.................#....................");
            AddMapRow(row++, "....#......................#....................................................................................................#...........");
            AddMapRow(row++, "...................................#....................................#.................................................................#.");
            AddMapRow(row++, "...........#...................................#.....#..............................#.............#.................#...............#.......");
            AddMapRow(row++, "........................................#...................................................................................................");
            AddMapRow(row++, "....................#..........#..............................................................#.............................................");
            AddMapRow(row++, "......#...................................................................................................................#.................");
            AddMapRow(row++, ".#.............................................................................................................................#............");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, ".............#............#.................................................................#...............................................");
            AddMapRow(row++, "...............................................................#.......................#....................................................");
            AddMapRow(row++, ".............................................#..........#................#................................................................#.");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, ".#.............................#.......................................................................#.............#.........#............");
            AddMapRow(row++, ".............................................................#.....#.............#...............#..........................................");
            AddMapRow(row++, "......#..............#..............#.......................................................................................................");
            AddMapRow(row++, ".........................................................#..................................................................................");
            AddMapRow(row++, "..............#.........................#.......................#...........................................................................");
            AddMapRow(row++, "................................#.................#............................................................#...................#........");
            AddMapRow(row++, ".............................................................................................#..............................................");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, "........................#.................#.......................#..................#......................................................");
            AddMapRow(row++, "..#.......................................................................................#................#.................#........#.....");
            AddMapRow(row++, ".........#........#................#...............#.........#....................................#.........................................");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, "........................................#..............................#.......................................#......#..........#..........");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, "......................#......................................................#...........................#..................................");
            AddMapRow(row++, "..#............#................#.......................#.....#...................................................#.........................");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, "............................#...............................................................#........#......................................");
            AddMapRow(row++, "............................................#...................................#......#..........................................#.........");
            AddMapRow(row++, "...........#......................#..................#....................#....................................#............................");
            AddMapRow(row++, "....................#..............................................#...................................................#....................");
            AddMapRow(row++, "...........................................................................................................................................#");
            AddMapRow(row++, "...#....................................#...............#.....#.....................#.......................................................");
            AddMapRow(row++, "...............#.......#........................#...............................................#......#..............................#.....");
            AddMapRow(row++, ".............................................................................................................................#..............");
            AddMapRow(row++, "........................................................................................................................#...................");
            AddMapRow(row++, "......#...............................................#........................#.................................................#..........");
            AddMapRow(row++, "....................................................................................................................#....................#..");
            AddMapRow(row++, "..#..........................................................#.........#...............#.....................#..............................");
            AddMapRow(row++, ".....................#............................#.........................................#.....#.........................................");
            AddMapRow(row++, "........#..........................#......#..............#...............................................................#...........#......");
            AddMapRow(row++, ".............#....................................................................................................#.........................");
            AddMapRow(row++, "................................................................#........................#..................................................");
            AddMapRow(row++, ".........................................................................#............................#.......#.................#...........");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, ".....................#...................#..................#.......#.................#.....#.............#............#....................");
            AddMapRow(row++, ".......#......................................#.......#.....................................................................................");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, "...............................#...............................#...................................................#...................#....");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, ".....#.................................#...............................................#....................#................#..............");
            AddMapRow(row++, ".................................................#......#...................................................................................");
            AddMapRow(row++, "......................................................................#............................................................#........");
            AddMapRow(row++, ".........#........#.......#........#................................................................................#.......................");
            AddMapRow(row++, "..............................................#.............................................................................................");
            AddMapRow(row++, "..#......................................#............#...........#...........................#...........................................#.");
            AddMapRow(row++, "...............#............................................................................................................................");
            AddMapRow(row++, "...........................................................................................................#................................");
            AddMapRow(row++, ".............................#..........................................#................#..................................................");
            AddMapRow(row++, ".....#......................................#..............#........................#...............................#.....#.............#...");
            AddMapRow(row++, ".......................#.............#...............#......................................................................................");
            AddMapRow(row++, "..................#.............#.................................#..........#..............................................................");
            AddMapRow(row++, "................................................#.......................................................#........#.............#...........#");
            AddMapRow(row++, "...#.......................#................................................................................................................");
            AddMapRow(row++, "..............#............................#...............................................................................#................");
            AddMapRow(row++, "........................................................#..............................#..........#..................#......................");
            AddMapRow(row++, "..............................................................#...................#........................#................................");
            AddMapRow(row++, "................................#...........................................................................................................");
            AddMapRow(row++, "..#..............#.............................#...................#.........#....................................#............#............");
            AddMapRow(row++, "...........#............................................................................................................................#...");
            AddMapRow(row++, "......#............................................#...................#.................................#..................................");
            AddMapRow(row++, "................................................................................#............#......#.......................................");
            AddMapRow(row++, "....................#.......................#........................................#....................................#.........#.......");
            AddMapRow(row++, "...............#.....................#......................................................................................................");
            AddMapRow(row++, ".............................#..................................................................................#...........................");
            AddMapRow(row++, "...#...................................................#..............#.........................#.......#...................................");
            AddMapRow(row++, "...............................................................................#............................................................");
            AddMapRow(row++, ".........................#.................................................................#.......................................#........");
            AddMapRow(row++, "..............................................................#...............................................................#.............");
            AddMapRow(row++, "........#............#.............#.........#.......#...............................................................#......................");
            AddMapRow(row++, ".......................................................................#...............#...........#........................................");
            AddMapRow(row++, "....#........#................#.........#.......................................#........................#..................................");
            AddMapRow(row++, "..............................................................................................................#.............#...............");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, ".........................#.....................................#..........#.......................................................#.........");
            AddMapRow(row++, ".........#...................................#..............................................................................................");
            AddMapRow(row++, ".......................................#..........#.........................................................#...............................");
            AddMapRow(row++, ".#............#............................................#..........#................#...........................#........................");
            AddMapRow(row++, "............................................................................................................................................");
            AddMapRow(row++, "........................................................................................................#...............................#...");
            AddMapRow(row++, "......#............................#...........................#..............................#..................................#..........");
            AddMapRow(row++, "......................#..........................................................................................#......#...................");
            AddMapRow(row++, "............................................#.....#......................#...........................#......................................");
            AddMapRow(row++, "...............#............#............................#.........................#........................................................");
            AddMapRow(row++, "........................................#............................................................................#......................");
            AddMapRow(row++, "........#...........................................................#...................#......................#..................#.........");
            AddMapRow(row++, "........................#.............................#............................................#........................................");
            AddMapRow(row++, "...............................#.............#..............#.............................................................#.................");
            AddMapRow(row++, ".................#............................................................................#.........................................#...");

            FindEmptyColumns();
       }

        void DumpMap()
        {
            for (var x = 0; x < mapSizeX; x++)
            {
                for (var y = 0; y < mapSizeY; y++)
                {
                    Console.SetCursorPosition(x, y);
                    Console.Write(map[(x, y)]);
                }
            }
        }
    }
}